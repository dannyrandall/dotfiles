/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */
function TagSelector(a,b,c){"use strict";function d(){return 0===P.value.indexOf("\n")}function e(){R||(R=new MutationObserver(function(a){a.forEach(function(a){if(a.addedNodes&&a.addedNodes.length>0)for(var b=0;b<a.addedNodes.length;b++){var c=a.addedNodes[b];"FONT"===c.tagName&&c.parentNode.removeChild(c)}})}));var a={childList:!0,subtree:!0};R.observe(P,a)}function f(){R&&R.disconnect()}function g(){var a=document.activeElement===P;return P.blur(),a}function h(a){j(G,a)}function i(a){j(H,a)}function j(a,b){for(var c=0;c<b.length;c++)for(var d=new Tag(b[c].name),e=b[c].name.split(/\s+/),f=0;f<e.length;f++)if(d.paths.indexOf(e[f])<0&&d.paths.push(e[f]),a.insert(e[f],d),CommonSelector.SPECIAL_CHAR_REGEX.test(e[f])){var g=e[f].replace(CommonSelector.SPECIAL_CHAR_REGEX,"");d.paths.indexOf(g)<0&&d.paths.push(g),a.insert(g,d)}}function k(a){if(void 0!==a&&a.length>E&&(a=a.substr(0,E)),S.children.length<D&&""!==a&&!l(a)){var b=document.createElement("div");b.innerText=a;var c=document.createElement("div");c.classList.add("tTag"),c.title=a,b.classList.add("tTagText");var d=document.createElement("div");d.classList.add("tDeleteTag"),d.addEventListener("click",function(){o(this.parentNode)}),c.appendChild(b),c.appendChild(d),S.appendChild(c),S.children.length>=D&&r(F.EXCEEDED_MAX),u(),J[a]=1}}function l(a){for(var b in J)if(b.toLowerCase()===a.toLowerCase())return!0;return!1}function m(a){k(a.trim()),P.value="",y(null,"")}function n(a){var b=document.createElement("div");b.innerText=a,b.title=a,b.classList.add("tDropdownTag"),b.addEventListener("mouseover",function(){for(var a=T.querySelectorAll(".tHover"),b=0;b<a.length;b++)a[b].classList.remove("tHover");this.classList.add("tHover")}),b.addEventListener("mousedown",function(a){1===a.which&&m(this.innerText),a.preventDefault()}),CommonSelector.binaryInsert(T,function(a){return a.innerText},b),K[a]=1}function o(a){delete J[a.querySelector(".tTagText").innerText],a.parentNode.removeChild(a),S.children.length<D&&s(),u(),c()}function p(){Array.prototype.slice.call(S.querySelectorAll(".tTag")).forEach(function(a){o(a)})}function q(a){P.setAttribute("placeholder",a),Q.querySelector("span").innerText=a}function r(a){P.classList.add("tDisabled"),a===F.EXCEEDED_MAX?q(Browser.i18n.getMessage("tagNamesNotInRange")):a===F.LINKED_NOTEBOOK&&(q(Browser.i18n.getMessage("quickNote_tagsDisabled")),S.style.display="none"),P.setAttribute("readonly","true"),c()}function s(){P.classList.remove("tDisabled"),S.style.display="",P.removeAttribute("readonly"),P.disabled=!1,q(Browser.i18n.getMessage("quickNote_addTags")),c()}function t(){var a=[];if(!O)for(var b in J)!J.hasOwnProperty(b)||P.classList.contains("tDisabled")&&P.classList.contains("tLinked")||a.push(GlobalUtils.removeControlCharacters(b));return a}function u(){for(var a=0,b=S.children.length-1;b>=0;b--)if(a||(a=S.children[b].offsetTop),S.children[b].offsetTop===a)S.children[b].classList.add("lastRow");else{if(!S.children[b].classList.contains("lastRow"))break;S.children[b].classList.remove("lastRow")}}function v(){P.focus()}function w(a,b){for(var c=a.join(" "),d=0;d<b.length;d++)if(!new RegExp("(\\s|^)"+b[d].replace(/([\\\^\$\.\|\?\*\+\(\)\[\{\]\}])/g,"\\$1"),"i").test(c))return!1;return!0}function x(){G=new Trie,H=new Trie,I=null}function y(a,c){if(T.innerHTML="",K={},a&&""!==c.trim())for(var d=c.split(/\s+/),e=a.getMatching(d[0],75),f=0;f<e.length;f++)for(var g=0;g<e[f][1].length;g++)J[e[f][1][g].name.toLowerCase()]||K[e[f][1][g].name]||!w(e[f][1][g].paths,d)||n(e[f][1][g].name);b()}function z(a){s(),O=!1,S.children.length>=D&&r(F.EXCEEDED_MAX),a===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?I=G:a===GlobalUtils.NOTEBOOK_TYPE_LINKED?(O=!0,r(F.LINKED_NOTEBOOK)):a===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(I=H)}function A(a){if(L){var b=t();b.length&&(M[L]=b)}L=a,p(),B(),SAFARI&&(S.style.display="none",S.style.display="")}function B(){if(L){var a=M[L];if(a)return void a.forEach(function(a){m(a)});var b=L;platform.channel.sendMessage("getRequiredTags",{accountSelector:L}).then(function(a){b==L&&a.forEach(function(a){tagSelector.addTagAndClearInput(a)})});var c=N[L]||{};c.tags&&c.tags.list&&c.tags.list.length&&c.tags.list.forEach(function(a){m(a.name)})}}function C(a){N=a,B()}var D=20,E=100,F={EXCEEDED_MAX:1,LINKED_NOTEBOOK:2},G=new Trie,H=new Trie,I=null,J={},K={},L=null,M={},N={},O=!1;a.classList.add("tContainer");var P=document.createElement("input");P.classList.add("tInput"),P.tabIndex=3,P.setAttribute("spellcheck",!1);var Q=document.createElement("div");Q.classList.add("tPlaceHolder"),Q.innerHTML="<span></span>",Q.setAttribute("spellcheck",!1),q(Browser.i18n.getMessage("quickNote_addTags"));var R,S=document.createElement("div");S.classList.add("tExisting");var T=document.createElement("div");T.classList.add("tDropdown"),s(),P.addEventListener("input",function(){var a=P.value.split(/\s*,\s*/);if(a.length>1)for(var b=0;b<a.length;b++)m(a[b]);else y(I,P.value)}),P.addEventListener("focus",function(){Q.classList.add("tPlaceHolderFocus"),EDGE&&e()}),P.addEventListener("blur",function(){Q.classList.remove("tPlaceHolderFocus"),m(P.value),P.hasAttribute("readonly")&&(P.disabled=!0),EDGE&&setTimeout(f,100)}),P.addEventListener("keydown",function(a){if((EDGE||FIREFOX)&&d()&&(P.value=P.value.replace(/\n/g,"")),13===a.keyCode){var b=T.querySelector(".tHover");m(b?b.innerText:P.value)}else if(38===a.keyCode||40===a.keyCode){var b=T.querySelector(".tHover");if(b){var c=null;c=38===a.keyCode?b.previousElementSibling:b.nextElementSibling}else c=T.firstElementChild;c&&(c.classList.add("tHover"),b&&b.classList.remove("tHover"),c.scrollIntoViewIfNeeded?c.scrollIntoViewIfNeeded():c.scrollIntoView()),a.preventDefault()}}),P.addEventListener("keyup",function(a){13===a.keyCode&&P.hasAttribute("readonly")&&(P.disabled=!0)}),T.addEventListener("mousedown",function(a){a.preventDefault()}),a.appendChild(Q),Q.appendChild(P),a.appendChild(S),a.appendChild(S),a.appendChild(T),this.abort=g,this.addBusinessTags=i,this.addPersonalTags=h,this.addTagAndClearInput=m,this.focus=v,this.getTags=t,this.reset=x,this.setActiveTrie=z,this.setSelectedAccount=A,this.setSmartFillingInfo=C,this.__defineGetter__("height",function(){return T.offsetTop+T.offsetHeight}),Object.preventExtensions(this)}function Tag(a){"use strict";this.name=a,this.paths=[],Object.preventExtensions(this)}Object.preventExtensions(TagSelector),Object.preventExtensions(Tag);