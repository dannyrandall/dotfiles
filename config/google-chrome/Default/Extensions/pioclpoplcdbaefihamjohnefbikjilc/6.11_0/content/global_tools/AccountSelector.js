/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */
"use strict";function AccountUserField(a){this.container=a||document.createElement("div"),this.container.classList.add("asUserField"),this._userIcon=document.createElement("div"),this._userIcon.classList.add("asUserIcon"),this._userLabel=document.createElement("div"),this._userLabel.classList.add("asUserLabel"),this._businessLabel=document.createElement("div"),this._businessLabel.classList.add("asBusinessLabel"),this._labels=document.createElement("div"),this._labels.classList.add("asLabels"),this._labels.appendChild(this._userLabel),this._labels.appendChild(this._businessLabel),this._dropdownIcon=document.createElement("div"),this._dropdownIcon.classList.add("asDropdownIcon"),this.container.appendChild(this._userIcon),this.container.appendChild(this._labels),this.container.appendChild(this._dropdownIcon),this.setShowsChevron(!1)}function AccountSelector(a,b,c,d){var e=this;this._globalContainer=a,this._userInfo={},this._selectedAccount=null,this._changeCallback=c,this._signInCallback=d,this._userField=new AccountUserField(b),this._userField.setShowsChevron(!0),this._userField.container.addEventListener("click",function(a){a.stopPropagation(),e.displayPopup()}),this._userLabel=document.createElement("div"),this._userLabel.classList.add("asUserLabel"),this._accountDropdownSelector=null,this.updateDisplay()}function AccountSelectorDropdown(a,b,c,d,e){if(!c)throw"Missing userInfo - are you logged in?";var f=this;this._globalContainer=a,this._element=b,this._selectedAccount=d,this._userInfo=c,this._clickFn=e,this._dropdownOverlay=document.createElement("div"),this._dropdownOverlay.classList.add("asDropdownOverlay"),this._dropdownOverlay.addEventListener("click",function(a){a.preventDefault(),f.close(),f._clickFn()}),this._personalAccountField=new AccountUserField,this._personalAccountField.container.accountSelector=GlobalUtils.ACCOUNT_SELECTOR_PERSONAL,this._personalAccountField.setDisplayLarge(!0),this._businessAccountField=new AccountUserField,this._businessAccountField.container.accountSelector=GlobalUtils.ACCOUNT_SELECTOR_BUSINESS,this._businessAccountField.setDisplayLarge(!1),this._dropdown=document.createElement("div"),this._dropdown.classList.add("asDropdown"),this._dropdown.appendChild(this._personalAccountField.container),this._dropdown.appendChild(this._businessAccountField.container),this._dropdown.addEventListener("click",function(a){a.preventDefault(),f.close(),f._clickFn(f.closestParentWithClass(a.target,"asUserField").accountSelector)}),this._keyDownHandler=function(a){f.handleKey(a)},this.updateDisplay()}AccountUserField.prototype.setHidden=function(a){this.container.style.display=a?"none":""},AccountUserField.prototype.setShowsChevron=function(a){this._dropdownIcon.style.display=a?"":"none"},AccountUserField.prototype.setDisplayLarge=function(a){this.container.classList.toggle("asLarge",a)},AccountUserField.prototype.updateUserImage=function(a){this._userIcon.style.backgroundImage=a?"url("+a+")":""},AccountUserField.prototype.setUserName=function(a){this._userLabel.innerText=a?a:"???"},AccountUserField.prototype.setBusinessName=function(a){this._businessLabel.innerText=a?a:""},AccountSelector.prototype.hasBusinessAccount=function(){return!!this._userInfo.bizAuthenticationToken},AccountSelector.prototype.updateSelectedAccount=function(){if(!this._selectedAccount){var a=this;platform.channel.sendMessage("getSelectedAccount").then(function(b){a.setSelectedAccount(b)})}},AccountSelector.prototype.getSelectedAccount=function(){return this._selectedAccount},AccountSelector.prototype.updateUserImage=function(a){var b=this;return platform.channel.sendMessage("downloadImage",{url:a,size:48}).then(function(a){b._selectedAccount===GlobalUtils.ACCOUNT_SELECTOR_PERSONAL&&b._userField.updateUserImage(a)}).catch(function(){b._userField.updateUserImage()})},AccountSelector.prototype.setUserInfo=function(a){this._userInfo=a||{},this.updateDisplay(),this.updateSelectedAccount()},AccountSelector.prototype.updateDisplay=function(){return this._userInfo.businessId?(this._userField.setHidden(!1),this._userField.setUserName(this._userInfo.fullName),this._userField.setBusinessName(this._userInfo.businessName||Browser.i18n.getMessage("Business")),this._userField.setDisplayLarge(this._selectedAccount===GlobalUtils.ACCOUNT_SELECTOR_PERSONAL),void(this._selectedAccount===GlobalUtils.ACCOUNT_SELECTOR_BUSINESS?this._userField.updateUserImage("../../images/account-selector-avatar-business.svg"):this.updateUserImage(this._userInfo.photoUrl))):void this._userField.setHidden(!0)},AccountSelector.prototype.setSelectedAccount=function(a){this._selectedAccount!=a&&(platform.channel.sendMessage("setSelectedAccount",{selectedAccount:a}),this._selectedAccount=a,this.updateDisplay(),this._changeCallback())},AccountSelector.prototype.toggleSelectedAccount=function(){if(this.hasBusinessAccount())switch(this._selectedAccount){case GlobalUtils.ACCOUNT_SELECTOR_BUSINESS:this.setSelectedAccount(GlobalUtils.ACCOUNT_SELECTOR_PERSONAL);break;case GlobalUtils.ACCOUNT_SELECTOR_PERSONAL:this.setSelectedAccount(GlobalUtils.ACCOUNT_SELECTOR_BUSINESS);break;default:throw"Unexpected selected account state"}},AccountSelector.prototype.displayPopup=function(){if(!this._accountDropdownSelector){var a=this;this._accountDropdownSelector=new AccountSelectorDropdown(this._globalContainer,this._userField,this._userInfo,this._selectedAccount,function(b){a.dismissedPopup(b)});var b=this._globalContainer.getBoundingClientRect(),c=this._userField.container.getBoundingClientRect();this._accountDropdownSelector.open(c.bottom-b.top)}},AccountSelector.prototype.dismissedPopup=function(a){var b=null;switch(a){case GlobalUtils.ACCOUNT_SELECTOR_PERSONAL:b="personal";break;case GlobalUtils.ACCOUNT_SELECTOR_BUSINESS:b="business"}return b&&Browser.sendToExtension({name:"trackEvent",category:"Account",action:"switch",label:b}),this._accountDropdownSelector=null,a!==GlobalUtils.ACCOUNT_SELECTOR_BUSINESS||this.hasBusinessAccount()?void(a&&this.setSelectedAccount(a)):void this._signInCallback()},AccountSelectorDropdown.prototype.moveSelection=function(a){var b=[].slice.call(this._dropdown.childNodes),c=b.findIndex(function(a){return a.accountSelector===this._selectedAccount},this);if(c===-1)return void log.error("Could not find selection option.");var d=Math.max(Math.min(c+a,b.length-1),0);d!==c&&(this._selectedAccount=b[d].accountSelector,this.updateSelection())},AccountSelectorDropdown.prototype.handleKey=function(a){if(this.isOpen())switch(a.keyCode){case 38:this.moveSelection(-1),a.stopPropagation();break;case 40:this.moveSelection(1),a.stopPropagation();break;case 27:this.close(),this._clickFn(),a.stopPropagation();break;case 13:this.close(),this._clickFn(this._selectedAccount),a.stopPropagation()}},AccountSelectorDropdown.prototype.closestParentWithClass=function(a,b){for(;a;){if(a.classList.contains(b))return a;a=a.parentElement}return null},AccountSelectorDropdown.prototype.hasBusinessAccount=function(){return this._userInfo.bizAuthenticationToken},AccountSelectorDropdown.prototype.updateDisplay=function(){var a=this;this._personalAccountField.setUserName(this._userInfo.fullName),platform.channel.sendMessage("downloadImage",{url:a._userInfo.photoUrl,size:48}).then(function(b){a._personalAccountField.updateUserImage(b)}).catch(function(){a._personalAccountField.updateUserImage()}),this.hasBusinessAccount()?(this._businessAccountField.setUserName(this._userInfo.fullName),this._businessAccountField.setBusinessName(this._userInfo.businessName||Browser.i18n.getMessage("Business")),a._businessAccountField.updateUserImage("../../images/account-selector-avatar-business.svg")):(this._businessAccountField.setUserName(Browser.i18n.getMessage("Sign_in")+" "+this._userInfo.fullName),this._businessAccountField.setBusinessName(this._userInfo.businessName||Browser.i18n.getMessage("Business")),a._businessAccountField.updateUserImage("../../images/account-selector-avatar-business-disabled.svg")),this.updateSelection()},AccountSelectorDropdown.prototype.updateSelection=function(){Array.prototype.slice.call(this._dropdown.childNodes).forEach(function(a){a.classList.toggle("asSelected",a.accountSelector==this._selectedAccount)},this)},AccountSelectorDropdown.prototype.isOpen=function(){return!!this._dropdown.parentNode},AccountSelectorDropdown.prototype.open=function(a){this.isOpen()||(this._globalContainer.appendChild(this._dropdownOverlay),this._globalContainer.appendChild(this._dropdown)),this._dropdown.style.top=a,Browser.pushKeyHandler(this._keyDownHandler)},AccountSelectorDropdown.prototype.close=function(){this.isOpen()&&(this._globalContainer.removeChild(this._dropdownOverlay),this._globalContainer.removeChild(this._dropdown),Browser.popKeyHandler(this._keyDownHandler))};