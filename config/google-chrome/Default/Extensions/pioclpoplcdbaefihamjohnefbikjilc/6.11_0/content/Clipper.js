/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */
define(["GlobalUtils","PageInfo"],function(a,b){function c(a,c,d){function e(b){k+=b,j<i.length?m(i[j++],null,a,e,null,d):c(k)}function f(b){g=b,l(g),m(g,null,a,e,null,d,h)}var g,h={isOutlookMail:b.isOutlookMail()},i=b.getNextPages(),j=1,k="";try{if(g=contentPreview.getArticleElement())return l(g),void m(g,null,a,e,null,d,h)}catch(a){log.warn("Couldn't get preview from contentPreview. Trying pageInfo.")}try{return void b.getDefaultArticle(f)}catch(a){log.warn("Couldn't get article from pageInfo. Trying default.")}g=document.body,l(g),m(g,null,a,e,null,d,h)}function d(a,b,c){l(document.body),m(document.body,null,a,b,null,c)}function e(c){c('<embed src="'+a.escapeXML(b.getPdfUrl())+'" type="application/pdf"></embed>')}function f(a,b){var c=contentPreview.getEmailElement();l(c),m(c,null,!0,a,null,b,{isEmailClip:!0})}function g(a,b,c,d){if(b&&document.querySelector("embed[type='application/pdf']"))return void c(b);var e,f;try{if(e=contentPreview.ensureSelectionIsShown(),e&&(f=e.getRangeAt(0))){if(f.commonAncestorContainer.nodeType==Node.TEXT_NODE){var g=f.commonAncestorContainer.textContent.substring(f.startOffset,f.endOffset);c(n(g))}else l(f.commonAncestorContainer),m(f.commonAncestorContainer,f,a,c,null,d);return}}catch(a){c("")}}function h(b,c){var d=document.querySelector("img[src='"+b+"'], img[src$='"+b.replace(document.body.baseURI,"")+"']"),e=t.convertImgSrcToBase64IfPossible(d,b,!0);e===b&&(e=a.escapeXML(e)),c('<img src="'+e+'"></img>')}function i(a){var b=contentPreview.getUrlElement(function(b){a(b)});b&&a(b)}function j(a,b){for(var c=contentPreview.getClearlyReformat(),d=c.$iframePages[0].getElementsByTagName("span"),e=0;e<d.length;e++)d.item(e).parentNode.removeChild(d.item(e));l(c.$iframePages[0]),m(c.$iframePages[0],null,!1,a,c.iframe.contentWindow,b)}function k(a,b){var c=contentPreview.getCustomElementContent();m(c,null,!1,a,c.ownerDocument.defaultView,b)}function l(a){for(var b=a.querySelectorAll("a.clearly_highlight_delete_element"),c=0;c<b.length;c++)b.item(c).parentNode.removeChild(b.item(c));for(var d=a.querySelectorAll("em.clearly_highlight_element"),c=0;c<d.length;c++)d.item(c).outerHTML="<highlight>"+d.item(c).innerHTML+"</highlight>"}function m(a,c,d,e,f,g,h){function i(a,b){b?g(b):r(a)}function j(a){t.serialize(o,p,q,i,a,null,h)}if(o=a,p=c,q=d,r=e,f)t.serialize(o,p,q,i,null,f);else try{h||(h={}),h.isOutlookMail=b.isOutlookMail(),serializeFrames(j,h)}catch(a){g(a)}}function n(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;")}var o,p,q,r,s={},t=new HtmlSerializer;return s.clipArticle=c,s.clipEmail=f,s.clipImage=h,s.clipFullPage=d,s.clipPdf=e,s.clipSelection=g,s.clipUrl=i,s.clipClearly=j,s.clipCustom=k,s});