/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */
function Bootstrapper(a){"use strict";function b(a){x=new JsonRpc(["UserStore.checkVersion","UserStore.getBootstrapInfo"],extension.getBaseUrl());var b=k.trim();""!==b&&(v=[b,b]),x.initWithUrl(n+v[a]+"/json");var e=new Date,f=e.getUTCMonth()+1<=9?"0"+(e.getUTCMonth()+1):(e.getUTCMonth()+1).toString(),g=f+e.getUTCDate().toString()+e.getUTCFullYear().toString(),h=Persistent.get("checkedVersion");h||(h={}),h[g]||(h[g]={});for(var i in h)i!==g&&delete h[i];Persistent.set("checkedVersion",h);var j=parseInt(Persistent.get("deviceID").substr(0,3),16)%1440,l=60*e.getUTCHours()+e.getUTCMinutes();if(u++,(void 0===h[g][v[a]]||null===h[g][v[a]])&&l>=j){h[g][v[a]]=!0,Persistent.set("checkedVersion",h);var m=GlobalUtils.generateSystemInfo(),o="EvernoteClipper/"+Browser.EVERNOTE_VERSION+"; "+m.browser.replace(" ","/")+"; "+m.os.replace(" ","/");x.client.UserStore.checkVersion(function(b,c){c&&"number"==typeof c.code&&200!=c.code||(h[g][v[a]]=b,Persistent.set("checkedVersion",h)),d(b,c)},o,EDAM_VERSION_MAJOR,EDAM_VERSION_MINOR),z&&(y=setTimeout(c,3e3))}else d(void 0===h[g][v[a]]||null===h[g][v[a]]?!0:h[g][v[a]])}function c(){y&&clearTimeout(y),x.client.UserStore.getBootstrapInfo(e,j),y=setTimeout(e,3e3)}function d(a,b){b&&("number"==typeof b.code&&200!=b.code?(log.warn("HTTP Error checking version. Assuming OK."),a=!0):log.log("Error checking version: "+JSON.stringify(b))),a===!0?z?c():f(q):(q=!1,alert(Browser.i18n.getMessage("checkVersionWarning")),f(q))}function e(a,c){if(y&&clearTimeout(y),a&&a.profiles&&a.profiles.list){a=a.profiles.list;for(var d=0,e=r.getName(),g=0;g<a.length;g++)"undefined"!=typeof a[g].name&&a[g].name===e&&(d=g);Persistent.set("BootstrapInfoIndex",d),Persistent.set("BootstrapInfo",a)}else{if(!(u>=2))return void b(t);log.error("Couldn't contact either bootstrap server. Using what we've got...")}f(q),p=!1}function f(a){for(var b=o.length-1;b>=0;b--){try{o[b](a)}catch(a){log.error("Error running callback: "+a.message+a.stack)}o.pop()}o=[]}function g(a,c){return a&&o.push(a),navigator.onLine?void(p||(z=c,b(s),p=!0)):(log.log("Bootstrapping while offline, will use existing info."),void f(q))}var h="zh-CN",i=!1,j=a||navigator.language,k=options.get("overrideServiceURL")||"",l=options.get("simulateSimplifiedChinese"),m=options.get("useStage"),n=options.get("secureProto");l&&(log.log("Will simulate Simplified Chinese."),i=!0,j=h);var o=[],p=!1,q=!0,r=new BootstrapInfo,s=0;j===h&&(s=1);var t=s?0:1,u=0,v=["www.evernote.com","app.yinxiang.com"],w=["stage.evernote.com","stage-china.evernote.com"];m&&(v=w);var x,y,z=!0;this.bootstrap=g,Object.preventExtensions(this)}function BootstrapInfo(){function a(a){if("name"==a)return d();if("serviceHost"==a){var b=options.get("overrideServiceURL");if(b&&(b=b.trim()),b)return log.log("Using overidden serviceHost: "+b),b}if("undefined"==typeof k[a])return log.error("Invalid Bootstrap Info Key: "+a),!1;var c=e(),f=Persistent.get(j);return f&&f.length>c&&f[c].settings?f[c].settings[a]:k[a]}function b(a){var b="requested host "+a,c=Persistent.get(j);if(c){for(var d=0;d<c.length;d++)if(c[d].settings&&c[d].settings.serviceHost===a)return d;log.warn(b+" not found in the bootstrap data")}else log.warn(b+", but no bootstrap data");return 0}function c(){var a=Persistent.get(j),b=[];return a&&a.forEach(function(a){a.settings&&a.settings.serviceHost&&b.push(a.settings.serviceHost)}),b}function d(){var a=e(),b=Persistent.get(j);return b&&b.length>a&&"undefined"!=typeof b[a].name?b[a].name:""}function e(){var a=Persistent.get(i);return a?a:0}function f(a){Persistent.set(i,a);var b=e();a!==b&&Persistent.clear("savedAuthInfo")}function g(){var a=Persistent.get(j);return a&&a.length?a.length:0}function h(a){var b=e(),c=Persistent.get(j);if(nextIdx=(b+1)%2,c&&c.length>nextIdx&&c[nextIdx].settings)return c[nextIdx].settings[a]}var i="BootstrapInfoIndex",j="BootstrapInfo",k={serviceHost:"www.evernote.com",marketingUrl:"http://www.evernote.com",supportUrl:"https://support.evernote.com",accountEmailDomain:"www.evernote.com",enableFacebookSharing:!0,enableGiftSubscriptions:!0,enableSharedNotebooks:!0,enableSingleNoteSharing:!0,enableSponsoredAccounts:!0,enableSupportTickets:!0,enableTwitterSharing:!0,enableLinkedInSharing:!0,enableGoogle:!0};this.getIndex=e,this.getHostIndex=b,this.setIndex=f,this.getLength=g,this.get=a,this.getAllHosts=c,this.getNextBootstrapData=h,this.getName=d,Object.preventExtensions(this)}Object.preventExtensions(Bootstrapper),Object.preventExtensions(BootstrapInfo);