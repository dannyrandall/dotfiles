/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */
define(["GlobalUtils","isTest"],function(a,b){"use strict";function c(b,c,d){function e(){var d={},e=extension.getPendingNote(b.pendingNoteKey);e||(e={}),e.relatedNotes||(e.relatedNotes={}),e.relatedNotes.pers=k&&k.relatedNotes?k.relatedNotes.list:[],l&&(e.relatedNotes.biz=l.relatedNotes?l.relatedNotes.list:[],e.relatedNotes.containingNotebooks=j),extension.setPendingNote(b.pendingNoteKey,e),d[a.ACCOUNT_SELECTOR_PERSONAL]={},d[a.ACCOUNT_SELECTOR_BUSINESS]={},b.notesOnly?b.callback(b.pendingNoteKey,c):("smartFiling"===options.get("notebookSelection")&&k&&k.notebook&&(d[a.ACCOUNT_SELECTOR_PERSONAL].notebook=k.notebook),"smartFiling"===options.get("bizNotebookSelection")&&s&&l&&l.notebook&&!l.notebook.restrictions.noCreateNotes&&(d[a.ACCOUNT_SELECTOR_BUSINESS].notebook=l.notebook)),options.get("smartFilingTags")&&k&&k.tags&&(d[a.ACCOUNT_SELECTOR_PERSONAL].tags=k.tags),options.get("bizSmartFilingTags")&&s&&l&&l.tags&&(d[a.ACCOUNT_SELECTOR_BUSINESS].tags=l.tags),d.name="receiveSmartFilingInfo",Browser.sendToTab(c.tab,d)}function f(){m=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],extension.getBaseUrl()),m.initWithShardId(account.userInfo.shardId,function(){s?(n=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],extension.getBaseUrl()),n.initWithShardId(account.userInfo.bizShardId,function(){g()})):g()})}function g(){var a={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:b.recText,url:b.url||c.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:m.shardId,userId:t,type:"pers"},m.client.NoteStoreExtra.getFilingRecommendations,i,r,a),s&&JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,userId:t,type:"biz"},n.client.NoteStoreExtra.getFilingRecommendations,h,s,a)}function h(a,b){if(p=!0,a){if(a.relatedNotes){j={};for(var c=0;c<a.containingNotebooks.list.length;c++){var d=a.containingNotebooks.list[c];j[d.guid]={joined:d.hasSharedNotebook,name:d.notebookDisplayName,contact:d.contactName}}}a.debugInfo&&(q.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo),l=a}else log.error(b);o&&e()}function i(a,c){o=!0,a?(k=a,a.debugInfo&&(q.write("TEXT",b.recText),q.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo)):log.error(c),(s&&p||!s)&&e()}var j,k,l,m,n,o,p,q,r=account.userInfo.authenticationToken,s=account.userInfo.bizAuthenticationToken,t=account.userInfo.userId;q=SAFARI||EDGE||FIREFOX?new LocalStorageLogWriter("relatedNotesDebugInfo"):new FSLogWriter("relatedNotesDebugInfo"),b.recText&&b.recText.trim()?f():e()}function d(b,c,d){account.reload().then(function(){function d(){e(),f(),y.bizAuthenticationToken?g():Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[],toOwnWindow:b.toOwnWindow})}function e(){P.getFilteredSyncChunk(y.authenticationToken,L[z].personal,x,new SyncChunkFilter({includeExpunged:M,includeNotebooks:!0}),h,o({request_name:"receivePersonalNotebooks"}))}function f(){P.getFilteredSyncChunk(y.authenticationToken,L[z].linked,x,new SyncChunkFilter({includeExpunged:N,includeLinkedNotebooks:!0}),i,o({request_name:"receiveSharedNotebooks"}))}function g(){R.getFilteredSyncChunk(y.bizAuthenticationToken,L[z].business,x,new SyncChunkFilter({includeExpunged:O,includeNotebooks:!0}),j,o({request_name:"receiveBusinessNotebooks"}))}function h(d){for(var f in d.notebooks)d.notebooks[f].shared=d.notebooks[f].sharedNotebooks&&d.notebooks[f].sharedNotebooks.length,s(H[z].personal,H[z].personalIndices,d.notebooks[f]);for(var f in d.expungedNotebooks)t(H[z].personal,H[z].personalIndices,d.expungedNotebooks[f]);Persistent.set("notebooks",H),L[z].personal=d.chunkHighUSN,Persistent.set("updateCounts",L),d.updateCount===L[z].personal?Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receivePersonalNotebooks",alwaysStartInNotebookGuid:K[a.ACCOUNT_SELECTOR_PERSONAL],notebooks:H[z].personal,recentNotebookGuid:J[a.ACCOUNT_SELECTOR_PERSONAL],toOwnWindow:b.toOwnWindow}):e()}function i(a){for(var b in a.linkedNotebooks){var c=a.linkedNotebooks[b];c.sharedNotebookGlobalId&&c.noteStoreUrl&&(s(H[z].linked,H[z].linkedIndices,c),Q[c.shardId]||(Q[c.shardId]=extension.createNoteStoreClientFromUrl(c.noteStoreUrl)),A&&c.businessId===A?B++:D++,Q[c.shardId].authenticateToSharedNotebook(c.sharedNotebookGlobalId,y.authenticationToken,k(c.shardId,c),p(c,"authenticateToSharedNotebook")))}for(var b in a.expungedLinkedNotebooks)u(a.expungedLinkedNotebooks[b]);Persistent.set("notebooks",H),L[z].linked=a.chunkHighUSN,Persistent.set("updateCounts",L),a.updateCount===L[z].linked?(F=!0,q(),r()):f()}function j(a){for(var b in a.notebooks){var c=a.notebooks[b];s(H[z].business,H[z].businessIndices,c),t(H[z].shared,H[z].sharedIndices,c.guid,H[z].sharedOwners)}for(var b in a.expungedNotebooks)t(H[z].business,H[z].businessIndices,a.expungedNotebooks[b]);Persistent.set("notebooks",H),L[z].business=a.chunkHighUSN,Persistent.set("updateCounts",L),a.updateCount===L[z].business?(G=!0,q()):g()}function k(a,b){return function(c){c.authenticationToken?Q[a].getSharedNotebookByAuth(c.authenticationToken,l(a,c,b,c.user||c.publicUserInfo),p(b,"getSharedNotebookByAuth")):A&&b.businessId===A?(C++,q()):(E++,r())}}function l(a,b,c,d){return function(e){H[z].linkedGuidToGuid[c.guid]&&H[z].linkedGuidToGuid[c.guid]!==e.notebookGuid&&(t(H[z].business,H[z].businessIndices,H[z].linkedGuidToGuid[c.guid]),t(H[z].shared,H[z].sharedIndices,H[z].linkedGuidToGuid[c.guid],H[z].sharedOwners)),H[z].linkedGuidToGuid[c.guid]=e.notebookGuid,Persistent.set("notebooks",H),A&&c.businessId===A?(C++,q()):Q[a].getNotebook(b.authenticationToken,e.notebookGuid,m(d),p(c,"getNotebook"))}}function m(a){return function(b){s(H[z].shared,H[z].sharedIndices,b,H[z].sharedOwners,a),Persistent.set("notebooks",H),E++,r()}}function n(a,d){a instanceof EDAMUserException&&a.errorCode===EDAMErrorCode.PERMISSION_DENIED&&"Business"===a.parameter?account.reload().then(function(a){a.bizAuthenticationToken?log.error("got error that user was not in business, but still got business token here"):Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[],toOwnWindow:b.toOwnWindow})}):(log.error(a),Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+d.request_name,notebooks:[],exception:v(a),toOwnWindow:b.toOwnWindow}))}function o(a){return function(b){n(b,a)}}function p(a,b){return function(c){var d="Couldn't get ";d+=A&&a.businessId===A?"business":"shared",d+=" notebook: "+a.shareName+" at "+b+" because of ",c instanceof EDAMUserException?(d+=c.__proto__.name,(c.errorCode||c.parameter)&&(d+="(",c.errorCode&&(d+=c.errorCode),c.parameter&&(d+=","+c.parameter),d+=")")):d+=c.toString()+": "+JSON.stringify(c),log.error(d),A&&a.businessId===A?(C++,q()):(E++,r())}}function q(){if(F&&G&&C===B){var d=[];for(var e in H[z].linked){var f=H[z].linked[e],g=H[z].linkedGuidToGuid[f.guid],h=H[z].businessIndices.indexOf(g);if(h>-1){var i=H[z].business[h];i.restrictions.noCreateNotes||d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:i.contact.id!==z?i.contact.name||i.contact.username:null,shared:i.sharedNotebooks&&i.sharedNotebooks.length>1,shardId:f.shardId,stack:f.stack,type:a.NOTEBOOK_TYPE_BUSINESS,published:i.published})}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",alwaysStartInNotebookGuid:K[a.ACCOUNT_SELECTOR_BUSINESS],notebooks:d,recentNotebookGuid:J[a.ACCOUNT_SELECTOR_BUSINESS],toOwnWindow:b.toOwnWindow})}}function r(){if(F&&D===E){var d=[];for(var e in H[z].linked){var f=H[z].linked[e],g=H[z].linkedGuidToGuid[f.guid];if(g){var h=H[z].sharedIndices.indexOf(g);if(h>-1){var i=H[z].shared[h];if(!i.restrictions.noCreateNotes){var j=i.contact||H[z].sharedOwners[h];d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:j.name||j.username,shardId:f.shardId,noteStoreUrl:f.noteStoreUrl,stack:f.stack,type:a.NOTEBOOK_TYPE_LINKED,shared:!0})}}}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveSharedNotebooks",alwaysStartInNotebookGuid:K[a.ACCOUNT_SELECTOR_PERSONAL],notebooks:d,recentNotebookGuid:J[a.ACCOUNT_SELECTOR_PERSONAL],toOwnWindow:b.toOwnWindow})}}function s(a,b,c,d,e){var f=-1;b&&b.indexOf?f=b.indexOf(c.guid):(log.warn("listIndices is incorrect! trying to find by guid. listIndices: "+b),f=a.findIndex(function(a){return a.guid===notebookGuid})),f>-1?(a[f]=c,d&&e&&(d[f]=e)):(a.push(c),b&&b.push&&b.push(c.guid),d&&e&&d.push(e))}function t(a,b,c,d){var e=-1;b&&b.indexOf?e=b.indexOf(c):(log.warn("listIndices is incorrect! trying to find by guid. listIndices: "+b),e=a.findIndex(function(a){return a.guid===c})),e>-1&&(a.splice(e,1),b&&b.splice&&b.splice(e,1),d&&d.splice&&d.splice(e,1))}function u(a){t(H[z].linked,H[z].linkedIndices,a);var b=H[z].linkedGuidToGuid[a];delete H[z].linkedGuidToGuid[a],b&&(t(H[z].shared,H[z].sharedIndices,b,H[z].sharedOwners),t(H[z].business,H[z].businessIndices,b))}function v(a){var b=Browser.i18n.getMessage("Error_Update_Notebooks");return 1!=a.isTrusted&&navigator.onLine!==!1||(b=Browser.i18n.getMessage("Error_Network_Unavailable")),{msg:b}}var w=1,x=50,y=account.userInfo,z=y.userId,A=y.businessId,B=0,C=0,D=0,E=0,F=!1,G=!1,H=Persistent.get("notebooks");H||(H={}),(!H[z]||H[z].version<w)&&(H[z]={version:w}),H[z].personal||(H[z].personal=[],H[z].personalIndices=[]),H[z].linked||(H[z].linked=[],H[z].linkedIndices=[]),H[z].linkedGuidToGuid||(H[z].linkedGuidToGuid={}),H[z].shared||(H[z].shared=[],H[z].sharedIndices=[],H[z].sharedOwners=[]),y.bizAuthenticationToken&&(H[z].business||(H[z].business=[],H[z].businessIndices=[]));var I=Persistent.get("recentAccountNotebooks")||{},J=I[z]||{},K={};K[a.ACCOUNT_SELECTOR_PERSONAL]="alwaysStartIn"===options.get("notebookSelection")?options.get("startNotebook"):null,K[a.ACCOUNT_SELECTOR_BUSINESS]="alwaysStartIn"===options.get("bizNotebookSelection")?options.get("bizStartNotebook"):null;var L=Persistent.get("updateCounts");L||(L={}),(!L[z]||L[z].version<w)&&(L[z]={version:w});var M=!0,N=!0,O=!0;L[z].personal||(L[z].personal=0,M=!1),L[z].linked||(L[z].linked=0,N=!1),y.bizAuthenticationToken&&(L[z].business||(L[z].business=0,O=!1));var P=extension.createNoteStoreClient(),Q={},R=null;y.bizAuthenticationToken&&(R=extension.createBusinessNoteStoreClient()),d()})}function e(a,b,c){function d(){var a=account.userInfo,c=extension.createNoteStoreClient();if(c.listTags(a.authenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receivePersonalTags",tags:a})},e),a.bizAuthenticationToken){var d=extension.createBusinessNoteStoreClient();d.listTags(a.bizAuthenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receiveBusinessTags",tags:a})},e)}}function e(a){a&&console.log(a)}d()}function f(a,b,c){function d(){var a,c=account.userInfo,d=extension.createNoteStoreClient();c.bizAuthenticationToken&&!f.personalNotebook&&(a=extension.createBusinessNoteStoreClient());var g=new Notebook({name:f.name});if(f.personalNotebook)d.createNotebook(c.authenticationToken,g,function(a){var c=null;!a.errorCode&&a.guid||(log.error("Error creating personal notebook"),log.error(a),c=e(a),a=null),Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:a,error:c})});else{if(!a)return Log.error("Generic error creating notebooks, "+!!a+JSON.stringify(f)),void Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:null,error:Browser.i18n.getMessage("Error_Create_Notebook")});a.createNotebook(c.bizAuthenticationToken,g,function(a){if(a.errorCode||!a.guid)return log.error("Error creating business shared notebook"),log.error(a),void Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:null,error:e(a)});var f={shardId:c.bizShardId,sharedNotebookGlobalId:a.sharedNotebooks[0].globalId,shareName:a.name,username:c.bizUserName},g=a.guid,h=new LinkedNotebook(f);d.createLinkedNotebook(c.authenticationToken,h,function(a){var c=null;!a.errorCode&&a.guid||(log.error("Error creating business linked notebook"),log.error(a),c=e(a),a=null),a.guid=g,Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:a,error:c})})})}}function e(a){var b=Browser.i18n.getMessage("Error_Create_Notebook");if(1==a.isTrusted||navigator.onLine===!1)return Browser.i18n.getMessage("Error_Network_Unavailable");switch(a.errorCode){case 2:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_InvalidName")}break;case 5:break;case 10:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_ExistingName")}break;case 6:switch(a.parameter){case"Notebook":b=Browser.i18n.getMessage("Error_Create_Notebook_QuotaReached")}}return b}var f=a.notebook;d()}function g(){account.reload().then(function(a){if(account.isAuthenticated){var b=Persistent.get("notebooks");b&&(delete b[a.userId],Persistent.set("notebooks",b));var c=Persistent.get("updateCounts");c&&(delete c[a.userId],Persistent.set("updateCounts"))}else log.log("logged out while clearing cached filing info")})}var h={};return Browser.addMessageHandlers({getNotebooks:d,getSmartFilingInfo:c,getTags:e,createNotebook:f}),h.getSmartFilingInfo=c,h.clearCachedFilingInfo=g,b&&(h.getNotebooks=d),h});