/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */
!function(){function a(a){this._onChanged=a&&"function"==typeof a.onChanged?a.onChanged:null,this._onServiceChanged=a&&"function"==typeof a.onServiceChanged?a.onServiceChanged:null,this.marketingUrl=a.marketingUrl||"",this._presentedDialog=null,this._waitingForDialog=!1,this.host=a.host||"",this._signInUrls=(a.viableHosts||[this.host]).map(function(a){return"https://"+a+"/ClipperLogin.action"}),this._initObserver()}var b=null,c=function(a,c){if(SAFARI){b=safari.application.activeBrowserWindow.activeTab;var d=safari.application.activeBrowserWindow.openTab();d.url=a,d.id||(d.id=Math.floor(1e5*Math.random())),c&&d&&c(d)}else{var e=610,f=710;chrome.windows.create({url:"about:blank",width:e,height:f,type:"popup",top:Math.round(Math.max(screen.availHeight-f,0)/2),left:Math.round(Math.max(screen.availWidth-e,0)/2)},function(b){c&&b&&(c(b),FIREFOX?chrome.tabs.query({windowId:b.id}).then(function(b){chrome.tabs.update(b[0].id,{url:a})}):chrome.tabs.update(b.tabs[0].id,{url:a}))})}},d=function(a){var b={};return(a.split("?")[1]||"").split("&").forEach(function(a){var c=a.split("=");b[c[0]]=c[1]}),b},e=function(a){return"true"===d(a).canClose};window.SSOManager=a,Object.defineProperty(a.prototype,"host",{get:function(){return this._host},set:function(a){this._host=a,this._generateUrls()}}),Object.defineProperty(a.prototype,"browserID",{get:function(){var a="clipper_chr";return SAFARI?a="clipper_saf":OPERA?a="clipper_op":YANDEX?a="clipper_yan":EDGE?a="clipper_edg":FIREFOX&&(a="clipper_ff"),a}}),a.prototype._initObserver=function(){if(!this._host)return console.error("Missing a host to observe SSO page.");var b=this,c=function(c,d){var f=c.url||"",g=void 0===d||"complete"===d,h=void 0===d||"loading"===d,i=b._isPresentedDialog(c);if(g&&b._isViableSignInUrl(f))b._switchHost(f),b._onChanged(a.SIGNIN_PRESENTED,c);else if(!i&&h&&f.startsWith(b._urls.webSignedIn))b._onChanged(a.SIGNED_IN,c);else if(i&&h&&(e(f)||f.startsWith(b._urls.webSignedIn))){b._switchHost(f);var j=a.SIGNED_IN;j|=f.indexOf("newReg=true")>-1?a.MANUAL_SIGNUP:a.MANUAL_SIGNIN,b.dismissSSOPage(),b._onChanged(j,c)}else h&&(f.startsWith(b.marketingUrl)||f.startsWith("https://"+b._host))&&b._urls.signedOutRegex.test(f)&&b._onChanged(a.SIGNED_OUT,c)};SAFARI?safari.application.addEventListener("navigate",function(a){c(a.target)}):(chrome.tabs.onUpdated.addListener(function(a,b,d){c(d,b.status||"")}),EDGE?chrome.tabs.onRemoved.addListener(function(a){b._presentedDialog&&a===b._presentedDialog.id&&(b._presentedDialog=null)}):chrome.windows.onRemoved.addListener(function(a){b._presentedDialog&&a===b._presentedDialog.id&&(b._presentedDialog=null)}))},a.prototype._isViableSignInUrl=function(a){for(var b=0;b<this._signInUrls.length;b++)if(a.startsWith(this._signInUrls[b]))return!0;return!1},a.prototype._switchHost=function(b){var c=b.match(a.HOST_REGEX)[1];this.host!==c&&this._onServiceChanged(c)},a.prototype._generateUrls=function(){var a="https://"+this._host;this._urls={signInForm:a+"/ClipperLogin.action",webSignedIn:a+"/Home.action",signedOutRegex:/(?:logged-out|LoggedOut\.action)/i}},a.prototype._activateSSOPage=function(){return!!this._presentedDialog&&(EDGE?(this.dismissSSOPage(),!1):(Browser.focusWindow(this._presentedDialog),!0))},a.prototype._isPresentedDialog=function(a){return!!this._presentedDialog&&(SAFARI?a.id===this._presentedDialog.id:a.windowId===this._presentedDialog.id)},a.prototype.presentSSOPage=function(){if(!this._host)return console.error("Missing a host to open SSO page.");if(!this._waitingForDialog&&!this._activateSSOPage()){this._waitingForDialog=!0;var a=this;c(a._urls.signInForm+"?wck="+a.browserID,function(c){SAFARI&&c.addEventListener("close",function(){b&&b.activate(),a._presentedDialog=null}),a._presentedDialog=c,a._waitingForDialog=!1})}},a.prototype.dismissSSOPage=function(){this._presentedDialog&&Browser.closeWindow(this._presentedDialog)},a.SIGNIN_PRESENTED=1,a.SIGNED_IN=2,a.SIGNED_OUT=4,a.MANUAL_SIGNIN=8,a.MANUAL_SIGNUP=16,a.HOST_REGEX=/https?:\/\/([a-z0-9-.]*)\//i,a.getStateString=function(b){var c=[];return b&a.SIGNIN_PRESENTED&&c.push("SIGNIN_PRESENTED"),b&a.SIGNED_IN&&c.push("SIGNED_IN"),b&a.SIGNED_OUT&&c.push("SIGNED_OUT"),b&a.MANUAL_SIGNIN&&c.push("MANUAL_SIGNIN"),b&a.MANUAL_SIGNUP&&c.push("MANUAL_SIGNUP"),c.join(" ")}}();