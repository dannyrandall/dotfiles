LPTabState=function(){var e={},t=null;LPPlatform.onTabClosed(function(t){delete e[t]}),Topics.get(Topics.CLEAR_DATA).subscribe(function(){e={}});var r=function(e,t){return lpmdec_acct(t,!0,e,g_shares)},s=function(e,t){t=[].concat(t);var s=t.indexOf(r(e,e.password));if(s===-1&&e.fields&&e.fields.length>0)for(var n=0;n<e.fields.length;++n){var a=e.fields[n];if("password"===a.type&&(s=t.indexOf(r(e,a.value)))>-1)break}return s>-1?t[s]:null},n=function(e,t){for(var r=0;r<e.length;++r){var n=s(e[r],t);if(n)return n}return null},a=function(){var e=function(e){var t=get_ff_translation(e);if(t)return new RegExp(t)},t=function(e,t){if(e&&t)return e.test(t.toLowerCase())},r=[function(){var r=function(e,r,s){return!(!t(r,e.id)&&!t(e.attributes.name))||(!!t(s,e.label)||void 0)};return function(t,s,n){for(var a=e("ff_ssn_regexp"),i=e("ff_text_ssn_regexp"),o=e("ff_cccsc_regexp"),u=e("ff_text_cccsc_regexp"),c=e("ff_securityanswer_regexp"),f=e("ff_captcha_regexp"),d=0;d<t.fields.length;++d){var l=t.fields[d];if(r(l,a,i)||r(l,o,u)||r(l,c)||r(l,f))return!1}}}(),function(e,t,r){if(1===t.uniquePasswords.length){var s=t.uniquePasswords[0];return 2===t.passwordsByValue[s].count&&(2===e.fields.length?e.passwordChangeForm=!0:e.createAccountForm=!0),s}},function(e,t,r){for(var s in t.passwordsByValue){if(t.passwordsByValue[s].count>1)return 2===t.uniquePasswords.length?(e.passwordChangeForm=!0,e.originalPassword=t.uniquePasswords[0]===s?t.uniquePasswords[1]:t.uniquePasswords[0]):e.createAccountForm=!0,s}},function(e,t,r){if(2===t.uniquePasswords.length){var s=n(r.getSites(),t.uniquePasswords);if(s)return e.passwordChangeForm=!0,e.originalPassword=s,t.uniquePasswords[0]===s?t.uniquePasswords[1]:t.uniquePasswords[0]}},function(e,t,r){for(var s in t.passwordsByValue){var n=t.passwordsByValue[s].field,a=["pw","pass"];if(c(n.attributes.name,a)||c(n.id,a))return s}}],s=function(r,s,n){var a=e("ff_username_regexp");if(a)for(var i=0;i<r.fields.length;++i){var o=r.fields[i];if(t(a,o.label))return o.value}},a=function(e,t,r){for(var s in t.textFieldsByValue){var n=t.textFieldsByValue[s].field;if(c(n.attributes.name,"user")||c(n.id,"user"))return s}},i=[s,function(e,t,r){if(1===t.uniqueTextValues.length){var s=t.uniqueTextValues[0];return 2===t.textFieldsByValue[s].count&&(e.createAccountForm=!0),s}},function(e,t,r){for(var s in t.textFieldsByValue)if(t.textFieldsByValue[s].count>1)return e.createAccountForm=!0,s},function(e,t,r){for(var s=e.fields,n=1;n<s.length;++n){if("password"===s[n].type){var a=s[n-1];if("password"!==a.type)return a.value}}},function(e,t,r){for(var s in g_sites)if(t.uniqueTextValues.indexOf(g_sites[s].unencryptedUsername)>-1)return g_sites[s].unencryptedUsername},function(e,t,r){var s=[];for(var n in t.textFieldsByValue){var a=n.match(/[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*/g);a&&1===a.length&&s.push(n)}if(1===s.length)return s[0]},a],o=function(){var e=function(e,t,r){var s=r[t];void 0===s?s=r[t]={field:e,count:1}:++s.count};return function(t){var r={},s={},n={};return t.fields.forEach(function(t){"password"===t.type?e(t,t.value,r):(e(t,t.value,s),e(t,t.type,n))}),{passwordsByValue:r,textFieldsByValue:s,textFieldsByType:n,uniqueTextValues:Object.keys(s),uniquePasswords:Object.keys(r)}}}(),c=function(e,t){if(e){t=[].concat(t);for(var r=0;r<t.length;++r)if(e.indexOf(t[r])>-1)return!0}return!1},f=function(e,t,r,s){for(var n=null,a=0;a<s.length&&(!(n=s[a](e,t,r))&&n!==!1);++a);return n};return function(e,t,n){t.fields=t.fields||[];var c=o(t),d=!1,l=!t.generatedPassword;t.password||(t.password=t.generatedPassword?t.generatedPassword:f(t,c,e,r)),t.username=function(){var r=i;n&&n.strict&&(r=[s,a]);var o=f(t,c,e,r),d=e.getSites().filter(function(e){return u(e,o)});return t.username&&0===d.length&&!t.createAccountForm?t.username:o}();var m=function(){if(t.username&&!t.createAccountForm)for(var e=0;e<t.fields.length;++e){var r=t.fields[e];if(r.value===t.username)return r}return null}();this.submitted=function(e){return"boolean"==typeof e&&(l=e),l},this.succeeded=function(e){return"boolean"==typeof e&&(d=e),d},this.getUsernameField=function(){return m},this.getUsername=function(){return t.username},this.getPassword=function(){return t.password},this.getFormData=function(){return t},this.getFields=function(){return t.fields.slice()},this.getOriginalPassword=function(){return t.originalPassword},this.isChangePasswordForm=function(){return t.passwordChangeForm===!0},this.isCreateAccountForm=function(){return t.createAccountForm===!0},this.isBasicAuthentication=function(){return t.basicAuthentication===!0},this.shouldSaveFields=function(){return!this.isChangePasswordForm()&&!this.isCreateAccountForm()}}}(),i=function(e){this.tabID=e.tabID,this.domain=lp_gettld_url(e.tabURL),this.sites=[],this.acccountsVersion=null,this.usernameField=null,this.username=null};i.prototype.getSites=function(){if(this.acccountsVersion!==g_local_accts_version){this.sites=[];var e=getsites(this.domain);for(var t in e)this.sites.push(g_sites[t]);this.acccountsVersion=g_local_accts_version}return this.sites},i.prototype.getFields=function(){var e=[];this.passwordForm&&(e=this.passwordForm.getFields());var t=this.getUsernameField();if(t&&t.value===this.getUsername()){0===e.filter(function(e){return e.name===t.name&&e.value===t.value}).length&&e.unshift(t)}return e.filter(function(e){return e.id||e.attributes.name})},i.prototype.getUsernameField=function(){if(!this.usernameField)for(var t in e){var r=e[t];if(r.usernameField&&compare_tlds(r.domain,this.domain)){this.usernameField=r.usernameField;break}}return this.usernameField},i.prototype.setUsernameField=function(e){e&&(this.usernameField=e)},i.prototype.setUsername=function(e){e&&(this.username=e)},i.prototype.getUsername=function(){if(!this.username&&this.passwordForm&&(this.username=this.passwordForm.getUsername()),!this.username)for(var t in e){var r=e[t];if(r.username&&compare_tlds(r.domain,this.domain)){this.username=r.username;break}}return this.username};var o=function(e,t){switch(t.transitionType){case"auto_subframe":case"manual_subframe":return!1}return t.transitionQualifiers.indexOf("from_address_bar")>-1||t.transitionQualifiers.indexOf("forward_back")>-1};i.prototype.processPasswordSubmit=function(e,t){this.passwordForm=new a(this,e),this.setUsernameField(this.passwordForm.getUsernameField()),this.setUsername(this.passwordForm.getUsername()),e.generatedPassword?this.generatedPassword=e.generatedPassword:LPPlatform.once(LPPlatform.onTransition,function(e){o(this,e)&&this.clear()},this)},i.prototype.processTextSubmit=function(e,t){var r=new a(this,e,{strict:!0});this.setUsernameField(r.getUsernameField()),this.setUsername(r.getUsername())};var u=function(){var e=function(e,t){if(t&&t.indexOf("@")>-1){var r=t.split("@");return 2===r.length&&e===r[0]}return!1},t=function(e){return e.indexOf("*")>-1||e.indexOf(String.fromCharCode(8226))>-1},s=function(e,r){return!!t(r)&&(e.length===r.length&&(e[0]===r[0]||e[e.length-1]===r[r.length-1]))},n=function(t,r){return t===r||e(t,r)||e(r,t)||s(t,r)};return function(e,t){if(t){if(n(e.unencryptedUsername,t))return!0;if(e.fields&&e.fields.length>0)for(var s=0;s<e.fields.length;++s){var a=e.fields[s];switch(a.type){case"text":case"email":case"tel":if(n(r(e,a.value),t))return!0}}}return!1}}();i.prototype.getMatchingSites=function(){var e=this,t=e.getSites();if(e.getUsername())t=t.filter(function(t){return u(t,e.getUsername())});else{var r=e.passwordForm&&e.passwordForm.getOriginalPassword();r&&(t=t.filter(function(e){return null!==s(e,r)})),0===t.length&&(t=e.getSites())}return t},i.prototype.shouldShowSiteNotification=function(){if(this.passwordForm&&this.passwordForm.succeeded())return this.passwordForm.isChangePasswordForm()?Preferences.get("showChangeNotificationBar"):Preferences.get("showSaveNotificationBar")};var c=function(){var e=function(e){var t="";return e.forEach(function(e){t+=e.formname+"\t"+encodeURIComponent(e.name)+"\t"+encodeURIComponent(crypto_btoa(e.value))+"\t"+encodeURIComponent(e.type)+"\n"}),bin2hex(t)};return function(t,r){if(r.length>0){t.fields=t.fields.concat(r),g_local_accts_version++,rewritelocalfile();var s={data:e(r),ref:url2hex(t.url),updatefields:1,aid:t.aid};t.sharedfolderid&&(s.sharedfolderid=t.sharedfolderid),t.postdata=new PostParams(s).toString(),t.posturl=base_url+"gm_deliver.php",t.newvalues=r,updateFieldsFromSubmit(t.postdata,t)}}}(),f=function(e){return{name:e.attributes.name||e.id,type:e.type,value:e.value,formname:""}},d=function(e,t){return t===e.unencryptedUsername?e.username:t===r(e,e.password)?e.password:lpmenc_acct(t,!0,e,g_shares)};i.prototype.addFields=function(e){if(this.getUsername()){var t=this.getFields();e.forEach(function(e){if(e.fields){var r=[];t.forEach(function(t){var s=f(t);0===e.fields.filter(function(r){return r.name===s.name&&(!e.save_all||r.formname===t.formname)}).length&&r.push({otherfield:e.save_all,name:s.name,type:s.type,value:d(e,t.value),checked:!1,formname:e.save_all?t.formname:"",urid:"0",otherlogin:"0",url:""})}),c(e,r)}})}},i.prototype.getSiteNotificationData=function(e){if(this.passwordForm){var t={formSubmitted:this.passwordForm.submitted(),formSucceeded:this.passwordForm.succeeded()};if(this.shouldShowSiteNotification()){var r=this.passwordForm.getFormData(),n=this.getMatchingSites(),a=n.filter(function(e){return null!==s(e,this.passwordForm.getPassword())},this);if(a.length>0)return this.addFields(a),this.clear({force:!0}),{};if(t.matchingSites=n.map(function(e){return e.aid}),t.defaultData={url:this.passwordForm.shouldSaveFields()?r.url:hostof(r.url),name:this.domain,unencryptedUsername:this.getUsername(),group:g_nofolder_feature_enabled?"":siteCats[this.domain],basic_auth:this.passwordForm.isBasicAuthentication()?"1":"0",realm:r.realm},t.dialogData={password:this.passwordForm.getPassword()},t.matchingSiteSameSubDomain=1===n.length&&hostof(n[0].url)===hostof(this.passwordForm.getFormData().url),t.sameDomain=compare_tlds(lp_gettld_url(this.passwordForm.getFormData().url),lp_gettld_url(e.tabURL)),t.generatedPassword=this.generatedPassword===this.passwordForm.getPassword(),this.passwordForm.shouldSaveFields()){this.getFields().length>0&&(t.dialogData.fields=this.getFields().map(f))}}else this.clear();return t}return{}},i.prototype.getFormSubmissionTabState=function(){for(var e=this;e;){if(e.passwordForm)return e;e=e.previousTabState}return this},i.prototype.getUsernames=function(){return this.getSites().map(function(e){return e.unencryptedUsername})},i.prototype.getSiteNotification=function(){var e=function(e,t,r){var s=e.getUsernames();t.forEachWindow({each:function(t,r){return t.LPContentScriptTools.findText({searches:s,callback:function(t){e.setUsername(t),r()}})},done:r})},t=function(t,r,s){var n=!1,a=LPTabs.get({tabID:t.tabID}),i=function(){if(t.passwordForm&&(t.passwordForm.succeeded()||t.passwordForm.succeeded(!n),t.passwordForm.succeeded()&&!t.passwordForm.getUsername()&&t.getSites().length>0))return void e(t,a,s);s()};if(r){var o=a.getFrame(r.frameID);o&&o.LPSiteNotification.formExists(t.passwordForm.getFormData(),function(e){n=e,i()})}else t.passwordForm.getFormData().top?a.getTop().LPSiteNotification.formExists(t.passwordForm.getFormData(),function(e){n=e,i()}):a.onFramesLoaded(function(){a.forEachFrame({each:function(e,r){return e.LPSiteNotification.formExists(t.passwordForm.getFormData(),function(e){n=n||e,r()})},done:i})})};return function(e,r){if(e.callback){var s=this.getFormSubmissionTabState(),n=function(){e.callback(s.getSiteNotificationData(r))};if(s.passwordForm&&s.passwordForm.getPassword()){if(s.domain===this.domain&&!s.passwordForm.isBasicAuthentication())return void t(s,e.source,n);s.passwordForm.succeeded(!0)}n()}}}(),i.prototype.clear=function(e){var t=e&&e.force,r=!0;return this.previousTabState&&(r=this.previousTabState.clear(e))&&delete this.previousTabState,this.passwordForm&&(this.passwordForm.getPassword()===this.generatedPassword&&(this.passwordForm.submitted(!1),r=!1),(r||t)&&(delete this.passwordForm,delete this.generatedPassword)),r},i.prototype.processBasicAuthentication=function(e){this.passwordForm=new a(this,{basicAuthentication:!0,url:e.url,realm:e.realm,username:e.username,password:e.password})};var l=function(e){if(!lploggedin)return!1;var t=lp_gettld_url(e.tabURL);if(LPContentScriptFeatures.new_save_site)return!hasNeverSave(e.tabURL,t)&&!lp_url_is_lastpass(e.tabURL)&&!lp_url_is_lastpassext(e.tabURL);var r=IntroTutorial.getState();return r.enabled&&r.domain===t},m=function(t,r){if(t){if(l(t)){var s=e[t.tabID];if(!s||!compare_tlds(s.domain,lp_gettld_url(t.tabURL))){var n=e[t.tabID]=new i(t);n.previousTabState=s,s=n}r(s)}}else LPPlatform.getCurrentTab(function(e){m(e.tabDetails,r)})},h=function(e,t){m(t,function(r){r.processTextSubmit(e,t)})},p=function(e,t){m(t,function(r){r.processPasswordSubmit(e.formData,t),r.getSiteNotification({callback:e.callback,source:t},t)})};return{getSiteNotification:function(e,t){m(t,function(r){r.getSiteNotification(e,t)})},clear:function(e,t){m(t,function(t){t.clear(e)})},processPasswordSubmit:p,processTextSubmit:h,processBasicAuthentication:function(e,t){m(t,function(t){t.processBasicAuthentication(e)})},getState:function(e,t){var r={enabled:l(t)};r.enabled?m(t,function(t){r.usernames=t.getUsernames(),r.formSubmittedFrame=t.passwordForm&&!t.passwordForm.getFormData().top,e(r)}):e(r)},setCopiedGeneratedPassword:function(e){t=e},getCopiedGeneratedPassword:function(e){e(t)}}}();